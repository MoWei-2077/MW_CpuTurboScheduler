const $=e=>document.querySelector(e),$$=e=>document.querySelectorAll(e),CONFIG={processName:"CpuTurboScheduler",configFile:"/storage/emulated/0/Android/CTS/config.json",logFile:"/storage/emulated/0/Android/CTS/log.txt",modeFile:"/storage/emulated/0/Android/CTS/mode.txt"};let currentConfig=null,currentMode="balance",currentLang=localStorage.getItem("lang")||"en";const i18n={en:{service_status:"Service Status",checking:"Checking...",running:"Running",stopped:"Stopped",quick_switch:"Quick Switch",select_mode:"Select performance mode",powersave:"Powersave",balance:"Balance",performance:"Performance",fast:"Fast",info:"Info",config_name:"Config Name",version:"Version",author:"Author",log_level:"Log Level",device_name:"Device Name",device_model:"Device Model",android_version:"Android Version",function:"Function",modes:"Modes",enable:"enable",save_config:"Save Config",frequency:"Frequency",governor:"Governor",core_online:"Core Online",runtime_log:"Runtime Log",loading:"Loading...",no_logs:"No logs available",failed_load_logs:"Failed to load logs",contributors:"Contributors",module_author:"Module Author",webui_author:"WebUI Author",license:"Licensed under GPL-3.0",nav_status:"Status",nav_config:"Config",nav_log:"Log",nav_about:"About",switching:"Switching...",mode_switched:"Mode switched",failed_switch:"Failed to switch",saving:"Saving...",config_saved:"Config saved",failed_save:"Failed to save",no_config:"No config loaded",init_error:"Init Error",lang_switched:"Language switched"},zh:{service_status:"服务状态",checking:"检查中...",running:"运行中",stopped:"已停止",quick_switch:"快速切换",select_mode:"选择性能模式",powersave:"省电",balance:"均衡",performance:"性能",fast:"极速",info:"信息",config_name:"配置名称",version:"版本",author:"作者",log_level:"日志级别",device_name:"设备名称",device_model:"设备型号",android_version:"安卓版本",function:"功能",modes:"模式",enable:"启用",save_config:"保存配置",frequency:"频率",governor:"调度器",core_online:"核心在线",runtime_log:"运行日志",loading:"加载中...",no_logs:"暂无日志",failed_load_logs:"加载日志失败",contributors:"贡献者",module_author:"模块作者",webui_author:"WebUI 作者",license:"遵循 GPL-3.0 协议",nav_status:"状态",nav_config:"配置",nav_log:"日志",nav_about:"关于",switching:"切换中...",mode_switched:"模式已切换",failed_switch:"切换失败",saving:"保存中...",config_saved:"配置已保存",failed_save:"保存失败",no_config:"未加载配置",init_error:"初始化错误",lang_switched:"语言已切换"}};function t(e){return i18n[currentLang]?.[e]||i18n.en[e]||e}function applyLanguage(){$$("[data-i18n]").forEach(e=>{const n=e.dataset.i18n;n&&(e.textContent=t(n))}),$$("[data-i18n-placeholder]").forEach(e=>{const n=e.dataset.i18nPlaceholder;n&&(e.placeholder=t(n))});const e=$("#status-text");if(e){const n=e.textContent;"Running"===n||"运行中"===n?e.textContent=t("running"):"Stopped"===n||"已停止"===n?e.textContent=t("stopped"):"Checking..."!==n&&"检查中..."!==n||(e.textContent=t("checking"))}const n=$("#current-mode");n&&currentMode&&(n.textContent=getModeDisplayName(currentMode))}const Shell={exec:e=>new Promise((t,n)=>{const o=`exec_callback_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,a=setTimeout(()=>{delete window[o],t({errno:-1,stdout:"",stderr:"timeout"})},15e3);window[o]=(e,n,i)=>{clearTimeout(a),delete window[o],t({errno:e||0,stdout:n||"",stderr:i||""})};try{"undefined"!=typeof ksu&&"function"==typeof ksu.exec?ksu.exec(e,JSON.stringify({}),o):(clearTimeout(a),delete window[o],console.log("[Shell] No KSU API, fallback mode:",e),t({errno:0,stdout:"",stderr:""}))}catch(e){clearTimeout(a),delete window[o],t({errno:-1,stdout:"",stderr:e.message||"unknown error"})}}),readFile:async e=>(await Shell.exec(`cat "${e}" 2>/dev/null`)).stdout||"",writeFile:async(e,t)=>{const n=t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\$/g,"\\$").replace(/`/g,"\\`");return 0===(await Shell.exec(`printf "%s" "${n}" > "${e}"`)).errno},isProcessRunning:async e=>{let t=await Shell.exec(`pidof ${e}`);return!!(t.stdout&&t.stdout.trim().length>0)||(t=await Shell.exec(`pgrep -f ${e}`),!!(t.stdout&&t.stdout.trim().length>0)||(t=await Shell.exec(`ps -A 2>/dev/null | grep -i ${e} | grep -v grep`),!!(t.stdout&&t.stdout.trim().length>0)))}};function initNavigation(){$$(".nav-tab").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.page,n=$(".page.active"),o=$(`#page-${t}`);n!==o&&($$(".nav-tab").forEach(e=>e.classList.remove("active")),e.classList.add("active"),n&&n.classList.remove("active"),o.classList.add("active"),$("#screen-title").textContent="CpuTurboScheduler","status"===t?loadStatus():"config"===t?loadConfig():"log"===t&&loadLog())})})}function initSwitchControls(){$$(".switch-control").forEach(e=>{const t=e.dataset.input,n=$(`#${t}`);n&&(updateSwitchState(t,n.checked),e.addEventListener("click",()=>{updateSwitchState(t,!n.checked)}))})}function updateSwitchState(e,t){const n=$(`#${e}`),o=$(`#${e}-switch`);if(n&&(n.checked=t),o&&(o.classList.toggle("checked",t),o.dataset.expand)){const e=o.dataset.expand,n=$(`#${e}`);if(n){const e=o.closest(".config-item");t?(n.classList.add("expanded"),e&&e.classList.remove("no-border")):(n.classList.remove("expanded"),e&&e.classList.add("no-border"))}}}async function loadStatus(){const e=await Shell.isProcessRunning(CONFIG.processName),n=$("#status-text"),o=$(".status-hero"),a=$(".hero-icon svg path");e?(n.textContent=t("running"),o.style.backgroundColor="var(--md-sys-color-primary-container)",o.style.color="var(--md-sys-color-on-primary-container)",a&&a.setAttribute("d","M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z")):(n.textContent=t("stopped"),o.style.backgroundColor="var(--md-sys-color-error-container)",o.style.color="var(--md-sys-color-on-error-container)",a&&a.setAttribute("d","M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"));try{const e=await Shell.readFile(CONFIG.configFile);e&&(currentConfig=JSON.parse(e),currentConfig.meta&&($("#config-name-info").textContent=currentConfig.meta.name||"--",$("#config-version-info").textContent=`v${currentConfig.meta.version||"?"}`,$("#config-author").textContent=currentConfig.meta.author||"--",$("#log-level").textContent=currentConfig.meta.loglevel||"--"))}catch(e){console.error("Failed to load config:",e)}try{const e=await Shell.exec("getprop ro.product.model 2>/dev/null"),t=e.stdout?.trim()||"Unknown";$("#device-model").textContent=t;let n=await Shell.exec("getprop ro.product.marketname 2>/dev/null"),o=n.stdout?.trim();o||(n=await Shell.exec("getprop bluetooth.device.default_name 2>/dev/null"),o=n.stdout?.trim()),o||(n=await Shell.exec("getprop ro.product.name 2>/dev/null"),o=n.stdout?.trim()||"Unknown"),$("#device-name").textContent=o;const a=await Shell.exec("getprop ro.build.version.release 2>/dev/null"),i=a.stdout?.trim()||"Unknown";$("#android-version").textContent=`Android ${i}`}catch(e){console.error("Failed to load device info:",e)}try{const e=await Shell.readFile(CONFIG.modeFile);e&&e.trim()&&(currentMode=e.trim()),$("#current-mode").textContent=getModeDisplayName(currentMode),updateModeButtons()}catch(e){console.error("Failed to load mode:",e)}}function getModeDisplayName(e){return t(e)||e}function initModeButtons(){$$(".mode-tile").forEach(e=>{e.addEventListener("click",()=>{switchMode(e.dataset.mode)})})}function updateModeButtons(){$$(".mode-tile").forEach(e=>{e.classList.toggle("active",e.dataset.mode===currentMode)})}async function switchMode(e){showToast(t("switching")),await Shell.writeFile(CONFIG.modeFile,e)?(currentMode=e,$("#current-mode").textContent=getModeDisplayName(e),updateModeButtons(),showToast(t("mode_switched"),"success")):showToast(t("failed_switch"),"error")}function initConfigTabs(){$$(".config-tab").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tab;$$(".config-tab").forEach(e=>e.classList.remove("active")),e.classList.add("active"),$$(".tab-content").forEach(e=>e.classList.remove("active")),$(`#tab-${t}`).classList.add("active")})})}async function loadConfig(){try{const e=await Shell.readFile(CONFIG.configFile);e&&(currentConfig=JSON.parse(e),populateConfigForm())}catch(e){console.error("Failed to parse config:",e),showToast("Failed to load config","error")}}function populateConfigForm(){if(!currentConfig)return;const e=currentConfig.Function,t=(e,t)=>{const n=$(e);n&&(n.value=void 0!==t?t:"",n.matches(".text-field.inline input")&&resizeInput(n))};if(e.Cpuset&&(updateSwitchState("cpuset-enable",e.Cpuset.enable||!1),t("#cpuset-top_app",e.Cpuset.top_app),t("#cpuset-foreground",e.Cpuset.foreground),t("#cpuset-restricted",e.Cpuset.restricted),t("#cpuset-system_background",e.Cpuset.system_background),t("#cpuset-background",e.Cpuset.background)),e.Boost&&(t("#boost-rate_limit_ms",e.Boost.boost_rate_limit_ms),e.Boost.BoostFreq&&(t("#boost-freq-c0",e.Boost.BoostFreq.c0),t("#boost-freq-c1",e.Boost.BoostFreq.c1),t("#boost-freq-c2",e.Boost.BoostFreq.c2),t("#boost-freq-c3",e.Boost.BoostFreq.c3))),e.LoadBalancing&&updateSwitchState("loadbalancing-enable",e.LoadBalancing.enable||!1),e.LaunchBoost&&updateSwitchState("launchboost-enable",e.LaunchBoost.enable||!1),e.DisableGpuBoost&&updateSwitchState("disablegpuboost-enable",e.DisableGpuBoost.enable||!1),e.IO_Optimization&&(updateSwitchState("io-enable",e.IO_Optimization.enable||!1),t("#io-scheduler",e.IO_Optimization.scheduler),t("#io-iostats",e.IO_Optimization.iostats),t("#io-nomerges",e.IO_Optimization.nomerges),t("#io-read_ahead_kb",e.IO_Optimization.read_ahead_kb)),e.Scheduler&&(updateSwitchState("scheduler-enable",e.Scheduler.enable||!1),t("#scheduler-latency_ns",e.Scheduler.sched_latency_ns),t("#scheduler-migration_cost_ns",e.Scheduler.sched_migration_cost_ns),t("#scheduler-min_granularity_ns",e.Scheduler.sched_min_granularity_ns),t("#scheduler-wakeup_granularity_ns",e.Scheduler.sched_wakeup_granularity_ns),t("#scheduler-nr_migrate",e.Scheduler.sched_nr_migrate),t("#scheduler-util_clamp_min",e.Scheduler.sched_util_clamp_min),t("#scheduler-util_clamp_max",e.Scheduler.sched_util_clamp_max),updateSwitchState("scheduler-energy_aware",e.Scheduler.sched_energy_aware||!1),updateSwitchState("scheduler-schedstats",e.Scheduler.sched_schedstats||!1)),currentConfig.meta&&currentConfig.meta.loglevel){const e=currentConfig.meta.loglevel;$("#config-loglevel").value=e,$$("#loglevel-tabs .mode-tab-btn").forEach(t=>{t.classList.toggle("active",t.dataset.level===e)})}initModeSettings()}function initModeSettings(){const e=$("#mode-select");$("#mode-tabs")&&$$("#mode-tabs .mode-tab-btn").forEach(t=>{t.addEventListener("click",()=>{const n=t.dataset.mode;$$("#mode-tabs .mode-tab-btn").forEach(e=>e.classList.remove("active")),t.classList.add("active"),e&&(e.value=n),renderModeSettings(n)})});const t=$("#mode-tabs .mode-tab-btn.active");renderModeSettings(t?t.dataset.mode:"powersave")}function addSchedParamRow(e,t="",n=""){const o=document.createElement("div");o.className="sched-param-row",o.innerHTML=`\n        <div class="text-field">\n            <input type="text" placeholder="Path" value="${t}">\n        </div>\n        <div class="text-field">\n            <input type="text" placeholder="Value" value="${n}">\n        </div>\n        <button class="delete-btn" title="Remove">\n            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>\n        </button>\n    `,o.querySelector(".delete-btn").addEventListener("click",()=>{o.remove()}),e.appendChild(o)}async function renderModeSettings(e){if(!currentConfig||!currentConfig.Switch||!currentConfig.Switch[e])return;const t=currentConfig.Switch[e],n=currentConfig.Policy||{},o=$("#freq-settings");o.innerHTML="";const a=["c0","c1","c2","c3"];a.forEach(a=>{if(-1===n[a])return;const i=t.MinFreq?.[a]||"",c=t.MaxFreq?.[a]||"";o.innerHTML+=`\n            <div class="freq-item">\n                <span class="freq-label">${a.toUpperCase()} Min</span>\n                <div class="text-field inline">\n                    <input type="text" id="freq-min-${a}-${e}" value="${i}">\n                </div>\n            </div>\n            <div class="freq-item">\n                <span class="freq-label">${a.toUpperCase()} Max</span>\n                <div class="text-field inline">\n                    <input type="text" id="freq-max-${a}-${e}" value="${c}">\n                </div>\n            </div>\n        `}),o.querySelectorAll(".text-field.inline input").forEach(e=>{resizeInput(e),e.addEventListener("input",()=>resizeInput(e))});const i=$("#governor-settings");i.innerHTML='<div class="loading-text">Loading governors...</div>';let c=["schedutil","performance","powersave"];try{const e=await Shell.exec("cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_available_governors 2>/dev/null");e.stdout&&e.stdout.trim()&&(c=e.stdout.trim().split(/\s+/))}catch(e){console.error("Failed to get governors",e)}i.innerHTML="",a.forEach(o=>{if(-1===n[o])return;const a=t.governor?.[o]||"",s=c.map(e=>`<option value="${e}" ${a===e?"selected":""}>${e}</option>`).join("");i.innerHTML+=`\n            <div class="freq-item">\n                <span class="freq-label">${o.toUpperCase()}</span>\n                <select class="governor-select" id="gov-${o}-${e}">\n                    ${s}\n                </select>\n            </div>\n        `});const s=$("#core-settings");if(s.innerHTML="",t.CoreOnline){for(let n=0;n<8;n++){const o=!1!==t.CoreOnline[`cpu${n}`];s.innerHTML+=`\n                <div class="core-item">\n                    <span class="core-label">Core ${n}</span>\n                    <div class="switch-control ${o?"checked":""}" \n                         id="core-${n}-${e}-switch" \n                         data-input="core-${n}-${e}">\n                        <div class="switch-thumb"></div>\n                    </div>\n                    <input type="checkbox" id="core-${n}-${e}" ${o?"checked":""} hidden>\n                </div>\n            `}setTimeout(()=>{$$("#core-settings .switch-control").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.input,n=$(`#${t}`);n&&(n.checked=!n.checked,e.classList.toggle("checked",n.checked))})})},0)}const r=$("#schedparam-settings");r&&(r.innerHTML="",t.SchedParam&&a.forEach(o=>{if(-1===n[o])return;const a=t.SchedParam[o]||{},i=document.createElement("div");i.className="sched-cluster-section",i.innerHTML=`<div class="sched-cluster-title">${o.toUpperCase()}</div>`;const c=document.createElement("div");c.id=`sched-${o}-${e}`,i.appendChild(c);for(let e=1;e<=20;e++){const t=`Path${e}`,n=`value${e}`;a[t]&&addSchedParamRow(c,a[t],a[n])}const s=document.createElement("div");s.className="add-sched-btn",s.innerHTML='\n                    <svg viewBox="0 0 24 24">\n                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>\n                    </svg>\n                ',s.addEventListener("click",()=>{addSchedParamRow(c)}),i.appendChild(s),r.appendChild(i)}))}function collectConfigFromForm(){if(!currentConfig)return null;const e=JSON.parse(JSON.stringify(currentConfig));e.Function||(e.Function={});const t=e.Function,n=e=>{const t=$(e);return t?t.value:""},o=e=>{const t=$(e);return!!t&&t.checked};t.Cpuset||(t.Cpuset={}),t.Cpuset.enable=o("#cpuset-enable"),t.Cpuset.top_app=n("#cpuset-top_app"),t.Cpuset.foreground=n("#cpuset-foreground"),t.Cpuset.restricted=n("#cpuset-restricted"),t.Cpuset.system_background=n("#cpuset-system_background"),t.Cpuset.background=n("#cpuset-background"),t.Boost||(t.Boost={}),t.Boost.boost_rate_limit_ms=parseInt(n("#boost-rate_limit_ms"))||50,t.Boost.BoostFreq||(t.Boost.BoostFreq={}),t.Boost.BoostFreq.c0=n("#boost-freq-c0"),t.Boost.BoostFreq.c1=n("#boost-freq-c1"),t.Boost.BoostFreq.c2=n("#boost-freq-c2"),t.Boost.BoostFreq.c3=n("#boost-freq-c3"),t.LoadBalancing||(t.LoadBalancing={}),t.LoadBalancing.enable=o("#loadbalancing-enable"),t.LaunchBoost||(t.LaunchBoost={}),t.LaunchBoost.enable=o("#launchboost-enable"),t.DisableGpuBoost||(t.DisableGpuBoost={}),t.DisableGpuBoost.enable=o("#disablegpuboost-enable"),t.IO_Optimization||(t.IO_Optimization={}),t.IO_Optimization.enable=o("#io-enable"),t.IO_Optimization.scheduler=n("#io-scheduler"),t.IO_Optimization.iostats=n("#io-iostats"),t.IO_Optimization.nomerges=n("#io-nomerges"),t.IO_Optimization.read_ahead_kb=n("#io-read_ahead_kb"),t.Scheduler||(t.Scheduler={}),t.Scheduler.enable=o("#scheduler-enable"),t.Scheduler.sched_latency_ns=n("#scheduler-latency_ns"),t.Scheduler.sched_migration_cost_ns=n("#scheduler-migration_cost_ns"),t.Scheduler.sched_min_granularity_ns=n("#scheduler-min_granularity_ns"),t.Scheduler.sched_wakeup_granularity_ns=n("#scheduler-wakeup_granularity_ns"),t.Scheduler.sched_nr_migrate=n("#scheduler-nr_migrate"),t.Scheduler.sched_util_clamp_min=n("#scheduler-util_clamp_min"),t.Scheduler.sched_util_clamp_max=n("#scheduler-util_clamp_max"),t.Scheduler.sched_energy_aware=o("#scheduler-energy_aware"),t.Scheduler.sched_schedstats=o("#scheduler-schedstats"),e.meta||(e.meta={}),e.meta.loglevel=n("#config-loglevel")||"INFO";const a=$("#mode-select")?$("#mode-select").value:"powersave";e.Switch||(e.Switch={}),e.Switch[a]||(e.Switch[a]={});const i=e.Switch[a],c=["c0","c1","c2","c3"];i.MinFreq||(i.MinFreq={}),i.MaxFreq||(i.MaxFreq={}),i.governor||(i.governor={}),c.forEach(e=>{const t=$(`#freq-min-${e}-${a}`),n=$(`#freq-max-${e}-${a}`),o=$(`#gov-${e}-${a}`);t&&(i.MinFreq[e]=t.value),n&&(i.MaxFreq[e]=n.value),o&&(i.governor[e]=o.value)}),i.CoreOnline||(i.CoreOnline={});for(let e=0;e<8;e++){const t=$(`#core-${e}-${a}`);t&&(i.CoreOnline[`cpu${e}`]=t.checked)}return i.SchedParam&&c.forEach(e=>{const t=$(`#sched-${e}-${a}`);if(!t)return;const n=t.querySelectorAll(".sched-param-row"),o={};let c=1;n.forEach(e=>{const t=e.querySelectorAll("input"),n=t[0].value.trim(),a=t[1].value.trim();n&&(o[`Path${c}`]=n,o[`value${c}`]=a,c++)});for(let e=c;e<=12;e++)o[`Path${e}`]="",o[`value${e}`]="";i.SchedParam[e]=o}),e}function initSaveButton(){$("#save-config").addEventListener("click",saveConfig),$("#save-config-modes").addEventListener("click",saveConfig)}async function saveConfig(){const e=collectConfigFromForm();if(!e)return void showToast(t("no_config"),"error");showToast(t("saving"));const n=JSON.stringify(e,null,4);await Shell.writeFile(CONFIG.configFile,n)?(currentConfig=e,showToast(t("config_saved"),"success")):showToast(t("failed_save"),"error")}async function loadLog(){const e=$("#log-content");e.innerHTML=`<pre class="log-text">${t("loading")}</pre>`;try{const n=await Shell.readFile(CONFIG.logFile);if(n&&n.trim()){const t=n.split("\n").slice(-200).filter(e=>e.trim()).map(e=>{let t="";e.includes("ERROR")||e.includes("错误")?t="error":e.includes("WARN")||e.includes("警告")?t="warn":e.includes("INFO")||e.includes("信息")?t="info":(e.includes("DEBUG")||e.includes("调试"))&&(t="debug");const n=e.match(/^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\s+(.+?)\s+->\s+(.+)$/);if(n){const[,e,o,a]=n;return`<div class="log-entry ${t}">\n                        <div class="log-timestamp">${escapeHtml(e)} ${escapeHtml(o)}</div>\n                        <div class="log-content">${escapeHtml(a)}</div>\n                    </div>`}return`<div class="log-entry ${t}">\n                        <div class="log-content">${escapeHtml(e)}</div>\n                    </div>`}).join("");e.innerHTML=t,e.scrollTop=e.scrollHeight}else e.innerHTML=`<pre class="log-text">${t("no_logs")}</pre>`}catch(n){e.innerHTML=`<pre class="log-text">${t("failed_load_logs")}</pre>`}}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function initRefreshButton(){$("#refresh-log").addEventListener("click",loadLog)}function showToast(e,t=""){const n=$("#toast");n.textContent=e,n.className="toast show"+(t?` ${t}`:""),setTimeout(()=>{n.className="toast"},2e3)}function initLogLevelSelector(){$$("#loglevel-tabs .mode-tab-btn").forEach(e=>{e.addEventListener("click",()=>{$$("#loglevel-tabs .mode-tab-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active"),$("#config-loglevel").value=e.dataset.level})})}function initThemeToggle(){const e=$("#theme-toggle");("light"===localStorage.getItem("theme")||!localStorage.getItem("theme")&&window.matchMedia("(prefers-color-scheme: light)").matches)&&document.body.classList.add("light-theme"),e.addEventListener("click",()=>{document.body.classList.toggle("light-theme");const e=document.body.classList.contains("light-theme");localStorage.setItem("theme",e?"light":"dark")})}function initLangToggle(){const e=$("#lang-toggle");applyLanguage(),e.addEventListener("click",()=>{currentLang="en"===currentLang?"zh":"en",localStorage.setItem("lang",currentLang),applyLanguage(),showToast(t("lang_switched"),"success")})}function initExternalLinks(){$$("[data-external-link]").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const n=e.dataset.externalLink;n&&void 0!==Shell&&Shell.exec?Shell.exec(`am start -a android.intent.action.VIEW -d "${n}"`).catch(e=>{console.error("Failed to open external link:",e),showToast("Failed to open link","error")}):window.open(n,"_blank")})})}function resizeInput(e){if(!e)return;const t=Math.max(e.value.length,(e.placeholder||"").length,1);e.style.width=`calc(${t}ch + 44px)`}function initAutoResizeInputs(){$$(".text-field.inline input").forEach(e=>{resizeInput(e),e.addEventListener("input",()=>resizeInput(e))})}document.addEventListener("DOMContentLoaded",async()=>{try{initImageCache(),initNavigation(),initConfigTabs(),initSwitchControls(),initModeButtons(),initSaveButton(),initRefreshButton(),initLogLevelSelector(),initThemeToggle(),initLangToggle(),initAutoResizeInputs(),initExternalLinks(),await loadStatus()}catch(e){console.error("Init error:",e),showToast(t("init_error")+": "+e.message,"error")}});const IMAGE_CACHE_EXPIRY=864e5;async function cacheImage(e){const t="img_cache_"+btoa(e),n=localStorage.getItem(t);if(n)try{const{data:e,timestamp:t}=JSON.parse(n);if(Date.now()-t<IMAGE_CACHE_EXPIRY)return e}catch(e){}try{const n=await fetch(e),o=await n.blob();return new Promise(e=>{const n=new FileReader;n.onloadend=()=>{const o=n.result;try{localStorage.setItem(t,JSON.stringify({data:o,timestamp:Date.now()}))}catch(e){}e(o)},n.readAsDataURL(o)})}catch(t){return e}}const APP_ICONS=["https://cts.fallsy.site/icon4.gif","https://cts.fallsy.site/icon2.gif","https://cts.fallsy.site/icon3.gif"];async function initImageCache(){rotateAppIcon();const e=$$("img[data-src]"),t=[];for(const n of e){const e=n.dataset.src;if(!e)continue;const o="img_cache_"+btoa(e),a=localStorage.getItem(o);if(a)try{const{data:e,timestamp:t}=JSON.parse(a);if(Date.now()-t<IMAGE_CACHE_EXPIRY){n.src=e;continue}}catch(e){}t.push(loadAndCacheImage(n,e,o))}t.length>0&&await Promise.all(t)}function rotateAppIcon(){const e=$(".app-logo img");if(!e)return;let t=parseInt(localStorage.getItem("app_icon_index")||"0",10);t=(t+1)%APP_ICONS.length,localStorage.setItem("app_icon_index",t.toString()),e.dataset.src=APP_ICONS[t]}async function loadAndCacheImage(e,t,n){try{const o=await fetch(t),a=await o.blob(),i=512e3,c=await new Promise((e,t)=>{const n=new FileReader;n.onloadend=()=>e(n.result),n.onerror=t,n.readAsDataURL(a)});if(e.src=c,c.length<i)try{localStorage.setItem(n,JSON.stringify({data:c,timestamp:Date.now()}))}catch(e){clearOldImageCaches();try{localStorage.setItem(n,JSON.stringify({data:c,timestamp:Date.now()}))}catch(e){}}}catch(n){e.src=t}}function clearOldImageCaches(){const e=Date.now(),t=[];for(let n=0;n<localStorage.length;n++){const o=localStorage.key(n);if(o&&o.startsWith("img_cache_"))try{e-JSON.parse(localStorage.getItem(o)).timestamp>432e5&&t.push(o)}catch(e){t.push(o)}}t.forEach(e=>localStorage.removeItem(e))}